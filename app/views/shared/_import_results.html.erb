<%= turbo_frame_tag "import_results" do %>
  <% if result[:processing] %>
    <div class="p-4 mb-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 rounded" id="import_processing">
      <p class="font-medium">Import in progress. Please wait...</p>
    </div>

    <script>
      const interval = setInterval(async () => {
        const resp = await fetch("<%= import_bugs_results_path(format: :turbo_stream) %>");
        const html = await resp.text();
        Turbo.renderStreamMessage(html);

        // Stop polling if the processing div is gone (import finished)
        if (!document.getElementById("import_processing")) {
          clearInterval(interval);
        }
      }, 3000);
    </script>

  <% else %>
    <div class="p-4 mb-4 bg-green-50 border-l-4 border-green-500 text-green-700 rounded">
      <p class="font-semibold">
        Successfully imported <span class="font-bold"><%= result[:success_count] %></span> bugs.
      </p>
    </div>

    <% if result[:failures].any? %>
      <% if result[:failures].size <= 10 %>
        <div class="p-4 mb-4 bg-red-50 border border-red-400 rounded-lg">
          <p class="text-red-700 font-semibold mb-2">
            <%= result[:failures].size %> rows failed to import.
          </p>
          <ul class="text-red-600 list-disc ml-5">
            <% result[:failures].each do |f| %>
              <% errors = f[:errors] || ["Unknown error"] %>
              <li>Row <%= f[:row] %>: <%= errors.join(", ") %></li>
            <% end %>
          </ul>
        </div>
      <% else %>
        <div class="p-4 mb-4 bg-red-50 border border-red-400 rounded-lg">
          <p class="text-red-700 font-semibold">
            <%= result[:failures].size %> rows failed. Please download the full errors file.
          </p>
        </div>
      <% end %>
      <p class="mt-2">
        <%= link_to "Download errors file",
            import_bug_result_download_path(current_user.id),
            data: { turbo: false },
            class: "underline font-medium hover:text-red-800" %>
      </p>
    <% end %>
  <% end %>
<% end %>
